# kops

# 1. 작업환경 구축

### 가상머신 준비

AWS EC2 인스턴스 생성 

- Ubuntu 18.04 AMI 선택
- 스토리지 크기 : 20
- 태그 : Name - k8s-ec2
- 보안그룹 : k8s-security-group, 내 IP만 허용
- 새 키 페어 생성 : k8s-ec2

![image](https://user-images.githubusercontent.com/77096463/112075064-1016b180-8bbb-11eb-9609-f2f5fe41e979.png)

<br>

탄력적 IP 주소 생성하여 k8s-ec2 인스턴스와 연결 > 재연결 시 퍼블릭 ip주소가 계속 바뀌기 때문에

![image](https://user-images.githubusercontent.com/77096463/112075207-65eb5980-8bbb-11eb-9e8d-9ddd9758886a.png)

<br>

### 인스턴스 접속 (xshell)

[cmd] ubuntu 18.04 AMI는 ubuntu로 사용자가 정해져 있음

```
C:\Users\Lenovo>cd C:\Users\Lenovo\Downloads

C:\Users\Lenovo\Downloads>ssh -i k8s-ec2.pem ubuntu@18.xx.xx.xx
The authenticity of host '18.xx.xx.xx (18.xx.xx.xx)' can't be established.
ECDSA key fingerprint is SHA256:CQCpxXqXXEofODPIlXoos5JWZOJaZS+9GsSs7ieQzjg.
Are you sure you want to continue connecting (yes/no)? yes
```

<br>

만일 접속이 안된다면 .ssh 라는 히든 폴더로 이동하여 known_hosts 내용 지운 다음 위의 명령어 재수행

```
C:\Users\Lenovo>cd .ssh
```

<br>

[xshell 연결 탭]

- 이름 : EC2-kops
- 호스트 : 인스턴스 퍼블릭 IPV4 주소
- 포트 번호 : 22

[xshell 사용자 인증 탭]

- 사용자 이름 : ubuntu
- 방법 : Public Key > k8s-ec2 키 페어 가져오기 후 선택

![image](https://user-images.githubusercontent.com/77096463/112076499-df844700-8bbd-11eb-9884-4f056692ee02.png)

<br>

### kops 설치

만일 wget이 없다면 `apt-get install -y wget`

```
$ wget -O kops https://github.com/kubernetes/kops/releases/download/$(curl -s https://api.github.com/repos/kubernetes/kops/releases/latest | grep tag_name | cut -d '"' -f 4)/kops-linux-amd64
$ chmod +x ./kops
$ sudo mv ./kops /usr/local/bin/kops
```

<br>

### kubectl 설치

```
$ wget -O kubectl https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
$ chmod +x ./kubectl
$ sudo mv ./kubectl /usr/local/bin/kubectl
```

<br>

### IAM - 그룹 생성, 사용자 생성

그룹 생성

- 이름 : k8s-group
- 정책 : 5가지 선택 (아래 화면 참고)

![image](https://user-images.githubusercontent.com/77096463/112079009-ca5de700-8bc2-11eb-8bac-6e59727406d7.png)

<br>

사용자 추가

- 사용자 이름 : k8s-user
- 액세스 유형 : 프로그래밍 방식 액세스 / AWS Management Console 액세스
- 그룹 k8s-group 선택
- 태그 : name - k8s-users
- 액세스 키  ID, 비밀 액세스 키 반드시 다운받기

![image](https://user-images.githubusercontent.com/77096463/112079465-8c14f780-8bc3-11eb-835c-00ab020468fd.png)

<br>

### AWS CLI 설치 후 설정

`aws configure` 명령어 입력 후 다운받은 사용자 액세스 키 ID, 비밀 액세스 키 값 입력 

```
$ sudo apt update
$ sudo apt-get install -y python3-pip
$ sudo apt install awscli

$ aws configure
AWS Access Key ID [None]: AKIXXXXXXXXXXXXXXXXXX
AWS Secret Access Key [None]: /jyrXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
Default region name [None]: us-east-1
Default output format [None]: 

$ aws ec2 describe-instances
$ aws iam list-users
{
    "Users": [
        {
            "Path": "/",
            "UserName": "k8s-user",
            "UserId": "AIDATXJSWD4OSGUD5BY7O",
            "Arn": "arn:aws:iam::256193732381:user/k8s-user",
            "CreateDate": "2021-03-23T01:34:43Z"
        }
    ]
}
```

<br>



# 2. 클러스터 생성

### S3 버킷 생성

```
$ aws s3api create-bucket --bucket haerim --region us-east-1
{
    "Location": "/haerim"
}

$ aws s3api put-bucket-versioning --bucket haerim --versioning-configuration Status=Enabled
```

<br>

### 환경 변수 설정

```
$ export AWS_ACCESS_KEY_ID=$<access_ID>
$ export AWS_SECRET_ACCESS=$<secret_access_key>
$ export NAME=haerimcluster.k8s.local
$ export KOPS_STATE_STORE=s3://haerim
```


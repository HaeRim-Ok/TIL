# Ansible

**모놀리스 vs 마이크로서비스**<br>
참고 : https://tommypagy.tistory.com/74

<br>

/etc/ansible/hosts 파일 내용 변경

```
[centos]
172.20.10.11
172.20.10.12

[webserver]
172.20.10.11

[backupserver]
172.20.10.12
172.20.10.13

[ubuntu]
172.20.10.13
```

<br>

### 1. 특정 서비스 설치 (중요)

루트 계정으로 진입하여 centos 그룹에 httpd 서비스 설치

```
[root@ansible-server ~]# ansible centos -m yum -a "name=httpd state=present" -k
```

<br>

설치가 잘 되었는지 확인

```
[vagrant@ansible-node01 ~]$ clear
[vagrant@ansible-node01 ~]$ yum list installed | grep httpd
httpd.x86_64                        2.4.6-97.el7.centos         @updates        
httpd-tools.x86_64                  2.4.6-97.el7.centos         @updates     

[vagrant@ansible-node02 ~]$ yum list installed | grep httpd
httpd.x86_64                        2.4.6-97.el7.centos         @updates        
httpd-tools.x86_64                  2.4.6-97.el7.centos         @updates       
```

<br>

httpd 서비스 현재 상태 확인 -> inactive

```
[vagrant@ansible-node01 ~]$ systemctl status httpd
● httpd.service - The Apache HTTP Server
   Loaded: loaded (/usr/lib/systemd/system/httpd.service; disabled; vendor preset: disabled)
   Active: inactive (dead)
     Docs: man:httpd(8)
           man:apachectl(8)

[vagrant@ansible-node02 ~]$ systemctl status httpd
● httpd.service - The Apache HTTP Server
   Loaded: loaded (/usr/lib/systemd/system/httpd.service; disabled; vendor preset: disabled)
   Active: inactive (dead)
     Docs: man:httpd(8)
           man:apachectl(8)
```

<br>

httpd 서비스 시작 후 상태 확인 -> active

```
[vagrant@ansible-node01 ~]$ sudo systemctl start httpd
[vagrant@ansible-node02 ~]$ sudo systemctl start httpd

[vagrant@ansible-node01 ~]$ systemctl status httpd
● httpd.service - The Apache HTTP Server
   Loaded: loaded (/usr/lib/systemd/system/httpd.service; disabled; vendor preset: disabled)
   Active: active (running) since Mon 2021-03-29 01:12:59 UTC; 3s ago
     Docs: man:httpd(8)
           man:apachectl(8)
 Main PID: 3291 (httpd)
   Status: "Processing requests..."
   CGroup: /system.slice/httpd.service
           ├─3291 /usr/sbin/httpd -DFOREGROUND
           ├─3292 /usr/sbin/httpd -DFOREGROUND
           ├─3293 /usr/sbin/httpd -DFOREGROUND
           ├─3294 /usr/sbin/httpd -DFOREGROUND
           ├─3295 /usr/sbin/httpd -DFOREGROUND
           └─3296 /usr/sbin/httpd -DFOREGROUND
```

<br>

현재 node01, node02의 httpd 서비스가 실행중이므로 127.0.0.1:20080, 127.0.0.1:10080 주소로 접근 가능

![image](https://user-images.githubusercontent.com/77096463/112775408-c8d76780-9077-11eb-8343-6f221ad4260b.png)

<br>

![image](https://user-images.githubusercontent.com/77096463/112775341-94fc4200-9077-11eb-8354-d6c594ba6a7d.png)

<br>

### 2. Playbook

사용자가 원하는 내용을 미리 작성해 놓은 스크립트 파일 (docker-compose와 비슷한 개념)<br>
ex) 다수의 서버에 반복 작업을 처리하는 경우

**멱등성** : 같은 설정을 여러번 적용하더라도 결과가 달라지지 않는 성질

```
[root@ansible-server ~]# echo -e "[mygroup]\n 172.20.10.11" >> /etc/ansible/hosts
```

위와 같은 명령어를 여러번 입력하면 /etc/ansible/hosts에 입력한 횟수만큼 커맨드가 추가됨 > 하지만 동일한 커맨드가 적용되었을때 한 번만 적용되게끔(=멱등성) 설정하기 위해 Playbook 이용 

<br>

작업 디렉터리 생성 및 이동 후 새로운 파일 생성

```
[root@ansible-server ~]# mkdir ansible-playbook
[root@ansible-server ~]# cd ansible-playbook/
[root@ansible-server ansible-playbook]# vi first-playbook.yml
```

```yaml
---
- name: Ansible_vim_test
  hosts: localhost
  tasks:
   - name: Add ansible hosts
     blockinfile: 
      path: /etc/ansible/hosts
      block: |
       [mygroup]
       172.20.10.11 
```

<br>

playbook 실행 후 잘 적용되었는지 확인

```
[root@ansible-server ansible-playbook]# ansible-playbook first-playbook.yml 

[root@ansible-server ansible-playbook]# tail -10 /etc/ansible/hosts
[backupserver]
172.20.10.12
172.20.10.13

[ubuntu]
172.20.10.13
# BEGIN ANSIBLE MANAGED BLOCK
[mygroup]
172.20.10.11 
# END ANSIBLE MANAGED BLOCK
```

<br>

:happy:**이후 playbook 실행을 여러 번 해도 같은 내용이 존재할 경우 지속적으로 반영되지 않고 한 번만 반영됨**

<br>

두번째 playbook 파일 작성 

```yaml
---
- name: Install nginx on CentOS
  hosts: centos
  remote_user: root
  tasks:
   - name: Install epel-release
     yum: name=epel-release state=latest
   - name: Install nginx web server
     yum: name=nginx state=present
   - name: Start nginx web server
     service: name=nginx state=started
```

<br>

playbook 실행 후 잘 적용되었는지 확인

```
[root@ansible-server ansible-playbook]# ansible-playbook second-playbook.yml -k

[vagrant@ansible-node01 ~]$ systemctl status nginx
● nginx.service - The nginx HTTP and reverse proxy server
   Loaded: loaded (/usr/lib/systemd/system/nginx.service; disabled; vendor preset: disabled)
   Active: active (running) since Mon 2021-03-29 01:58:22 UTC; 3s ago
  Process: 3888 ExecStart=/usr/sbin/nginx (code=exited, status=0/SUCCESS)
  Process: 3886 ExecStartPre=/usr/sbin/nginx -t (code=exited, status=0/SUCCESS)
  Process: 3884 ExecStartPre=/usr/bin/rm -f /run/nginx.pid (code=exited, status=0/SUCCESS)
 Main PID: 3890 (nginx)
   CGroup: /system.slice/nginx.service
           ├─3890 nginx: master process /usr/sbin/ngin...
           └─3891 nginx: worker process
```

<br>

127.0.0.1:10080 주소로 접속 가능 (마찬가지로 127.0.0.1:20080 주소도 접속 가능)

![image](https://user-images.githubusercontent.com/77096463/112777713-de4f9000-907d-11eb-8e78-ebe15cb7d79e.png)

<br>
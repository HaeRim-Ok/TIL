**TDD** (Test Driven Development)<br>
테스트 코드 생성 > 실제 개발하기 직전 > 처음에는 무조건 실패 > 성공

<br>

### MariaDB에 Data Insert

order_ms.py에 MariaDB 데이터 추가하는 코드 작성

```python
import flask
from flask import Flask, jsonify, request
from flask_restful import reqparse
from datetime import datetime

import flask_restful
import mariadb
import json
import uuid

app = Flask(__name__)
app.config["DEBUG"] = True
api = flask_restful.Api(app)

config = {
    'host': '127.0.0.1',
    'port': 3306,
    'user': 'root',
    'password': 'mysql',
    'database': 'mydb'
}

@app.route('/order-ms')
def index():
    return "Welcome to ORDER Microservice!"

class Order(flask_restful.Resource):
    def __init__(self):
        self.conn = mariadb.connect(**config)
        self.cursor = self.conn.cursor()

    def get(self, user_id):
        sql = "select user_id, order_id, coffee_name, coffee_price, coffee_qty, ordered_at from orders where user_id=? order by id desc"
        self.cursor.execute(sql, [user_id])
        result_set = self.cursor.fetchall()
        
        print(self.cursor.description)
        
        json_data = []
        for result in result_set:
            json_data.append(result)

        return jsonify(json_data)

    def post(self, user_id):
        json_data = request.get_json()
        json_data['user_id'] = user_id
        json_data['order_id'] = str(uuid.uuid4()) 
        json_data['ordered_at'] = str(datetime.today())

        # DB insert
        sql = "INSERT INTO orders(user_id, order_id, coffee_name, coffee_price, coffee_qty, ordered_at) VALUES (?,?,?,?,?,?)"

        self.cursor.execute(sql, [user_id,
                                json_data['order_id'],
                                json_data['coffee_name'],
                                json_data['coffee_price'],
                                json_data['coffee_qty'],
                                json_data['ordered_at']])
        self.conn.commit()

        # Kafka message send

        response = jsonify(json_data)
        response.status_code = 201
        
        return response

class OrderDetail(flask_restful.Resource):
    def get(self, user_id, order_id):
        return {'user_id': user_id, 'order_id': order_id}

api.add_resource(Order, '/order-ms/<string:user_id>/orders')
api.add_resource(OrderDetail, '/order-ms/<string:user_id>/orders/<string:order_id>')

if __name__ == '__main__':
    app.run()
```

<br>

POST http://localhost:5000/order-ms/USER0001/orders

![image](https://user-images.githubusercontent.com/77096463/113646635-272dc700-96c4-11eb-9a20-230c138c8e0a.png)

<br>

GET http://localhost:5000/order-ms/USER0001/orders

![image](https://user-images.githubusercontent.com/77096463/113646696-49274980-96c4-11eb-8538-a66d8c17d10f.png)

<br>

`print(self.cursor.description)` 코드 실행 시 아래와 같은 결과 출력

```
(
    ('user_id', 253, 100, 400, 0, 0, False, 4097), 
    ('order_id', 253, 100, 400, 0, 0, False, 4097), 
    ('coffee_name', 253, 100, 400, 0, 0, False, 4097), 
    ('coffee_price', 3, 2, 11, 0, 0, False, 36865), 
    ('coffee_qty', 3, 2, 11, 0, 0, True, 32768), 
    ('ordered_at', 253, 50, 200, 0, 0, True, 0)
)
```

<br>

이를 이용하여 GET 메서드 호출 시 데이터와 함께 컬럼명을 출력하도록 코드 수정

```python
...
    def get(self, user_id):
        sql = "select user_id, order_id, coffee_name, coffee_price, coffee_qty, ordered_at from orders where user_id=? order by id desc"
        self.cursor.execute(sql, [user_id])
        result_set = self.cursor.fetchall()
        
        row_headers = [x[0] for x in self.cursor.description]
        
        json_data = []
        for result in result_set:
            json_data.append(dict(zip(row_headers, result)))

        return jsonify(json_data)
...
```

<br>

결과 확인

![image](https://user-images.githubusercontent.com/77096463/113646825-90add580-96c4-11eb-8add-17be1e0eff47.png)

<br>


### Kafka message send

delivery_status 테이블 생성

```sql
CREATE TABLE delivery_status(
	id INT AUTO_INCREMENT PRIMARY KEY,
	order_json TEXT,
	created_at DATETIME DEFAULT NOW()
);
```

<br>


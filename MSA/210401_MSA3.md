# AWS & Ansible

> ansible-server 54.174.86.113 172.31.26.185
> ansible-node01 54.163.43.181 172.31.27.220
> ansible-node02 54.159.42.36 172.31.24.143

### 1. Ping test

ansible-ec2-node01 ping 테스트

```
[ec2-user@ip-172-31-26-185 ~]$ ping 172.31.27.220
PING 172.31.27.220 (172.31.27.220) 56(84) bytes of data.
64 bytes from 172.31.27.220: icmp_seq=1 ttl=255 time=0.723 ms
64 bytes from 172.31.27.220: icmp_seq=2 ttl=255 time=0.608 ms
64 bytes from 172.31.27.220: icmp_seq=3 ttl=255 time=0.578 ms
^C
--- 172.31.27.220 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2029ms
rtt min/avg/max/mdev = 0.578/0.636/0.723/0.065 ms
```
ansible-ec2-node02 ping 테스트
```
[ec2-user@ip-172-31-26-185 ~]$ ping 172.31.24.143
PING 172.31.24.143 (172.31.24.143) 56(84) bytes of data.
64 bytes from 172.31.24.143: icmp_seq=1 ttl=255 time=0.816 ms
64 bytes from 172.31.24.143: icmp_seq=2 ttl=255 time=0.638 ms
64 bytes from 172.31.24.143: icmp_seq=3 ttl=255 time=0.638 ms
^C
--- 172.31.24.143 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2035ms
rtt min/avg/max/mdev = 0.638/0.697/0.816/0.086 ms
```

<br>

### 2. SSH 접속

devlopment 보안 그룹 확인하면 ansible 서버 내에서 통신하지 못하도록 돼있음 (ssh 접속이 아예 안됨) > **인바운드 규칙으로 SSH 유형/devlopment보안그룹 소스 등록**

![image](https://user-images.githubusercontent.com/77096463/113227176-0254e080-92cd-11eb-9bdd-9b0fc526775a.png)

<br>

ssh 접속은 되나 Permission denied 에러 발생

```
[ec2-user@ip-172-31-26-185 ~]$ ssh 172.31.27.220
The authenticity of host '172.31.27.220 (172.31.27.220)' can't be established.
ECDSA key fingerprint is SHA256:7Tywb3MMzGQ8bn+0mVWLnXOpHKrkm0JQLKEwByhZKRk.
ECDSA key fingerprint is MD5:23:98:01:e9:4c:f0:e3:70:a6:72:4b:9d:14:2a:ca:45.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '172.31.27.220' (ECDSA) to the list of known hosts.
Permission denied (publickey,gssapi-keyex,gssapi-with-mic).

[ec2-user@ip-172-31-26-185 ~]$ ssh 172.31.24.143
The authenticity of host '172.31.24.143 (172.31.24.143)' can't be established.
ECDSA key fingerprint is SHA256://Mj/B/6+J8nCuOeGyH1+Hc+/vI7mmbT1v3T14Ud2M4.
ECDSA key fingerprint is MD5:98:30:ff:93:72:a9:14:ec:84:7e:ab:6e:88:d6:c6:c1.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '172.31.24.143' (ECDSA) to the list of known hosts.
Permission denied (publickey,gssapi-keyex,gssapi-with-mic).
```

<br>

키 생성 > 이후 ssh-copy-id를 통해 키를 전달해야 하나 이 또한 ssh를 이용하므로 권한 문제 발생

```
[ec2-user@ip-172-31-26-185 ~]$ ssh-keygen
```

<br>

따라서 ansible-server의 id_rsa.pub 키를 각각의 노드가 가진 authorized_keys 파일에 등록 필요<br>
**즉, id_rsa.pub의 내용을 authorized_keys 내용 모두 지운 후 붙여넣기**

![image](https://user-images.githubusercontent.com/77096463/113228127-27e2e980-92cf-11eb-8f74-d3c7f19130c1.png)

<br>

이후 각 노드로 ssh 접속 가능 확인

ansible-ec2-node01

```
[ec2-user@ip-172-31-26-185 .ssh]$ ssh 172.31.27.220
Last login: Thu Apr  1 00:24:14 2021 from 175.125.198.37

       __|  __|_  )
       _|  (     /   Amazon Linux 2 AMI
      ___|\___|___|

https://aws.amazon.com/amazon-linux-2/
[ec2-user@ip-172-31-27-220 ~]$ 
```
ansible-ec2-node02
```
[ec2-user@ip-172-31-26-185 .ssh]$ ssh 172.31.24.143
Last login: Thu Apr  1 00:24:47 2021 from 175.125.198.37

       __|  __|_  )
       _|  (     /   Amazon Linux 2 AMI
      ___|\___|___|

https://aws.amazon.com/amazon-linux-2/
[ec2-user@ip-172-31-24-143 ~]$ 
```

<br>

### 3. ansible hosting 수정 후 테스트

/etc/ansible/hosts에 노드 정보 입력

```
[ec2-user@ip-172-31-26-185 .ssh]$ sudo vi /etc/ansible/hosts
```

```
[ec2]
172.31.27.220
172.31.24.143

[node1]
172.31.27.220

[node2]
172.31.24.143
```

<br>

ec2그룹에 ping 테스트

```
[ec2-user@ip-172-31-26-185 .ssh]$ ansible ec2 -m ping

172.31.24.143 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false, 
    "ping": "pong"
}

172.31.27.220 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false, 
    "ping": "pong"
}
```
ec2그룹에 uptime 테스트
```
[ec2-user@ip-172-31-26-185 .ssh]$ ansible ec2 -m shell -a "uptime"

172.31.27.220 | CHANGED | rc=0 >>
 01:17:48 up  1:04,  2 users,  load average: 0.00, 0.00, 0.00

172.31.24.143 | CHANGED | rc=0 >>
 01:17:48 up  1:04,  2 users,  load average: 0.00, 0.00, 0.00
```
node1 메모리 테스트
```
[ec2-user@ip-172-31-26-185 .ssh]$ ansible node1 -m shell -a "free -h"

172.31.27.220 | CHANGED | rc=0 >>
              total        used        free      shared  buff/cache   available
Mem:           983M         91M        694M        488K        197M        759M
Swap:            0B          0B          0B
```
node2 Disk Space 테스트
```
[ec2-user@ip-172-31-26-185 .ssh]$ ansible node2 -m shell -a "df -h"

172.31.24.143 | CHANGED | rc=0 >>
Filesystem      Size  Used Avail Use% Mounted on
devtmpfs        482M     0  482M   0% /dev
tmpfs           492M     0  492M   0% /dev/shm
tmpfs           492M  488K  492M   1% /run
tmpfs           492M     0  492M   0% /sys/fs/cgroup
/dev/xvda1       20G  1.6G   19G   8% /
tmpfs            99M     0   99M   0% /run/user/1000
tmpfs            99M     0   99M   0% /run/user/0
```

<br>


# 인증과 권한

**사용자 정보, 인증 다이어그램**

![diagram](https://user-images.githubusercontent.com/77096463/111246480-ac840580-8649-11eb-86ab-8a83870354a2.png)

<br>

**카카오 소셜 로그인 추가**<br>
https://developers.kakao.com 접속하여 애플리케이션 추가 선택

- 이름 : 24-Hour Video
- 카카로 로그인 활성화 : ON
- Redirect URI : https://mementohaeri.us.auth0.com/login/callback

![image](https://user-images.githubusercontent.com/77096463/111239011-a71fbe80-863b-11eb-9f04-f6b2a36c1d88.png)

<br>

내 애플리케이션 > 앱 설정 > 플랫폼에 사이트 도메인 추가

![image](https://user-images.githubusercontent.com/77096463/111239376-5f4d6700-863c-11eb-85c8-e975bbea3f3b.png)

<br>

auth0의 ClientID와 Client Secret으로 각각 '요약 정보 > 앱 키 > REST API 키'와  '내 애플리케이션 > 제품 설정 > 카카오 로그인 > 보안 > Client Secret 키'를 입력한다.<br>
(단, 이 때 확인하고자 하는 항목에 따라 동의항목 설정을 일부 변경할 것 )

![image](https://user-images.githubusercontent.com/77096463/111240026-c1f33280-863d-11eb-8c06-6d1148bd6c4f.png)

<br>

**깃허브 소셜 로그인 추가**<br>
https://github.com/settings/developers 에 접속하여 OAuth Apps > new OAuth app 선택
- Application name : authorization
- Homepage URL : https://mementohaeri.us.auth0.com/login/callback
- Authorization callback URL : https://mementohaeri.us.auth0.com

![image](https://user-images.githubusercontent.com/77096463/111241788-29f74800-8641-11eb-812b-15f2c36055ba.png)

<br>

위와 같이 입력한 후 OAuth 앱을 생성하면 새로운 client ID와 client secret이 발급된다.<br>
이후 auth0.com 에서 github connections를 생성하면 아래와 같이 접속 가능


![image](https://user-images.githubusercontent.com/77096463/111241718-07652f00-8641-11eb-8dd4-353ecb81d149.png)

<br>

### Storage -> HTML5에 추가된 기능

참고 : https://developer.mozilla.org/ko/docs/Web/API/Web_Storage_API/Using_the_Web_Storage_API<br>
브라우저에서 쿠키를 사용하는 것보다 훨씬 직관적으로 **key/value 데이터를 안전하게 저장**할 수 있는 메커니즘 제공

- **sessionStorage**: 페이지의 **세션이 유지되는 동안 사용**할 수 있는 각 origin별로 별도의 스토리지를 관리합니다. (페이지 리로딩 및 복원을 포함한, 브라우저가 열려있는 한 최대한 긴 시간 동안)
- **localStorage**: sessionStorage와 같은 일을 하지만, **브라우저가 닫히거나 다시 열리더라도 유지**합니다.

![image](https://user-images.githubusercontent.com/77096463/111246995-9e82b480-864a-11eb-83d8-a0800cb46161.png)

<br>

### 3. AWS와 통합

### JWT 토큰 검증

웹 사이트에서 JWT(JSON Web Token)를 승인하고 유효성을 검증한 후 auth0.com으로 사용자에 대한 추가 정보를 요청하는 람다 함수를 작성

![image](https://user-images.githubusercontent.com/77096463/111247172-e1dd2300-864a-11eb-9da1-5fd7174fd984.png)

<br>

### 사용자 프로필 조회하는 람다 함수 

IAM 콘솔에서 api-gateway-lambda-exec-role **역할** 생성

- 사용 사례 : Lambda
- 권한 정책 연결 : AWSLambdaBasicExecutionRole

![image](https://user-images.githubusercontent.com/77096463/111247746-ea822900-864b-11eb-8ab2-4070a822a75b.png)

<br>

**람다함수 생성**

> 1. JSON Web Token 검증
> 2. auth0 엔드포인트를 호출해서 사용자 정보를 조회
> 3. 웹 사이트에 응답을 전송

- 이름 : user-profile
- 런타임 : Node.js 12.x
- 실행 역할 : 기존 역할 사용 > api-gateway-lambda-exec-role 선택

![image](https://user-images.githubusercontent.com/77096463/111248056-7d22c800-864c-11eb-8461-23c440af907e.png)

<br>

**작업 디렉터리 생성 및 필요한 모듈 설치**

```
PS C:\serverless> mkdir user-profile
PS C:\serverless> cd .\user-profile\

PS C:\serverless\user-profile> npm init -y
PS C:\serverless\user-profile> npm install jsonwebtoken
PS C:\serverless\user-profile> npm install request
```

<br>

package.json 파일에 deploy, predeploy 스크립트 추가

```json
//C:\serverless\user-profile\package.json
{
  "name": "user-profile",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "predeploy": "del Lambda-Deployment.zip & zip -r Lambda-Deployment.zip * -x *.zip *.log node_modules/aws-sdk/*", 
    "deploy": "aws lambda update-function-code --function-name arn:aws:iam::256193732381:role/api-gateway-lambda-exec-role --zip-file fileb://Lambda-Deployment.zip"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "jsonwebtoken": "^8.5.1",
    "request": "^2.88.2"
  }
}
```

<br>

index.js 파일 작성

```js
//C:\serverless\user-profile\index.js

```


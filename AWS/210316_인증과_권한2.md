# 인증과 권한

**사용자 정보, 인증 다이어그램**

![diagram](https://user-images.githubusercontent.com/77096463/111246480-ac840580-8649-11eb-86ab-8a83870354a2.png)

<br>

**카카오 소셜 로그인 추가**<br>
https://developers.kakao.com 접속하여 애플리케이션 추가 선택

- 이름 : 24-Hour Video
- 카카로 로그인 활성화 : ON
- Redirect URI : https://mementohaeri.us.auth0.com/login/callback

![image](https://user-images.githubusercontent.com/77096463/111239011-a71fbe80-863b-11eb-9f04-f6b2a36c1d88.png)

<br>

내 애플리케이션 > 앱 설정 > 플랫폼에 사이트 도메인 추가

![image](https://user-images.githubusercontent.com/77096463/111239376-5f4d6700-863c-11eb-85c8-e975bbea3f3b.png)

<br>

auth0의 ClientID와 Client Secret으로 각각 '요약 정보 > 앱 키 > REST API 키'와  '내 애플리케이션 > 제품 설정 > 카카오 로그인 > 보안 > Client Secret 키'를 입력한다.<br>
(단, 이 때 확인하고자 하는 항목에 따라 동의항목 설정을 일부 변경할 것 )

![image](https://user-images.githubusercontent.com/77096463/111240026-c1f33280-863d-11eb-8c06-6d1148bd6c4f.png)

<br>

**깃허브 소셜 로그인 추가**<br>
https://github.com/settings/developers 에 접속하여 OAuth Apps > new OAuth app 선택
- Application name : authorization
- Homepage URL : https://mementohaeri.us.auth0.com/login/callback
- Authorization callback URL : https://mementohaeri.us.auth0.com

![image](https://user-images.githubusercontent.com/77096463/111241788-29f74800-8641-11eb-812b-15f2c36055ba.png)

<br>

위와 같이 입력한 후 OAuth 앱을 생성하면 새로운 client ID와 client secret이 발급된다.<br>
이후 auth0.com 에서 github connections를 생성하면 아래와 같이 접속 가능


![image](https://user-images.githubusercontent.com/77096463/111241718-07652f00-8641-11eb-8dd4-353ecb81d149.png)

<br>

### Storage -> HTML5에 추가된 기능

참고 : https://developer.mozilla.org/ko/docs/Web/API/Web_Storage_API/Using_the_Web_Storage_API<br>
브라우저에서 쿠키를 사용하는 것보다 훨씬 직관적으로 **key/value 데이터를 안전하게 저장**할 수 있는 메커니즘 제공

- **sessionStorage**: 페이지의 **세션이 유지되는 동안 사용**할 수 있는 각 origin별로 별도의 스토리지를 관리합니다. (페이지 리로딩 및 복원을 포함한, 브라우저가 열려있는 한 최대한 긴 시간 동안)
- **localStorage**: sessionStorage와 같은 일을 하지만, **브라우저가 닫히거나 다시 열리더라도 유지**합니다.

![image](https://user-images.githubusercontent.com/77096463/111246995-9e82b480-864a-11eb-83d8-a0800cb46161.png)

<br>

### 3. AWS와 통합

### JWT 토큰 검증

웹 사이트에서 JWT(JSON Web Token)를 승인하고 유효성을 검증한 후 auth0.com으로 사용자에 대한 추가 정보를 요청하는 람다 함수를 작성

![image](https://user-images.githubusercontent.com/77096463/111247172-e1dd2300-864a-11eb-9da1-5fd7174fd984.png)

<br>

### 사용자 프로필 조회하는 람다 함수 

IAM 콘솔에서 api-gateway-lambda-exec-role **역할** 생성

- 사용 사례 : Lambda
- 권한 정책 연결 : AWSLambdaBasicExecutionRole

![image](https://user-images.githubusercontent.com/77096463/111247746-ea822900-864b-11eb-8ab2-4070a822a75b.png)

<br>

**람다함수 생성**

> 1. JSON Web Token 검증
> 2. auth0 엔드포인트를 호출해서 사용자 정보를 조회
> 3. 웹 사이트에 응답을 전송

- 이름 : user-profile
- 런타임 : Node.js 12.x
- 실행 역할 : 기존 역할 사용 > api-gateway-lambda-exec-role 선택

![image](https://user-images.githubusercontent.com/77096463/111248056-7d22c800-864c-11eb-8461-23c440af907e.png)

<br>

**작업 디렉터리 생성 및 필요한 모듈 설치**

- `jsonwebtoken` 모듈 : 토큰의 무결성 확인하고 디코딩 하는데 도움
- `request` 모듈 : Auth0에 사용자 정보를 검색하도록 요청하기 위해 사용

```
PS C:\serverless> mkdir user-profile
PS C:\serverless> cd .\user-profile\

PS C:\serverless\user-profile> npm init -y
PS C:\serverless\user-profile> npm install jsonwebtoken
PS C:\serverless\user-profile> npm install request
```

<br>

package.json 파일에 deploy, predeploy 스크립트 추가

```json
//C:\serverless\user-profile\package.json
{
  "name": "user-profile",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "predeploy": "del Lambda-Deployment.zip & zip -r Lambda-Deployment.zip * -x *.zip *.log node_modules/aws-sdk/*", 
    "deploy": "aws lambda update-function-code --function-name arn:aws:lambda:us-east-1:256193732381:function:user-profile --zip-file fileb://Lambda-Deployment.zip"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "jsonwebtoken": "^8.5.1",
    "request": "^2.88.2"
  }
}
```

<br>

index.js 파일 생성 및 코드 작성 > <u>토큰의 유효성 검사, 디코딩하는 역할</u>

```js
//AWS 람다 서비스를 통해서 실행되는 코드
'use strict';

var jwt = require('jsonwebtoken');
var request = require('request');

exports.handler = function(event, context, callback){
    console.log(JSON.stringify(event));
    
    //event 객체에 authToken과 accessToken 존재 여부 확인
    //만약 존재하지 않으면 return
    if(!event.authToken){
        callback('Could not find authToken');
        return;
    }

    if(!event.accessToken){
        callback('Could not find authToken');
        return;
    }

    //authToken의 값을 공백문자를 기준으로 분리한 후 두번째 값을 id_token 변수 에 할당
    //authToken은 Bearer.x.x.x 형식을 가지기 때문에 
    var id_token = event.authToken.split(' ')[1];
    var access_token = event.accessToken;

    var body = {
        'id_token': id_token,
        'access_token' : access_token
    };

    //환경변수 DOMAIN 값은 auth0.com에 설정되어 있는 사용자의 DOMAIN
    //auth0.com에서 사용자 프로필 정보 조회에 필요한 값 설정 -> 로그인 시 전달받은 access_token을 요청 파라미터로 전달해야 함
    var options={
        url: 'https://'+ process.env.DOMAIN +'/userinfo',
        method: 'GET',
        json: true,
        body: body
    };

    //auth0.com으로 사용자 프로필 정보를 실질적으로 조회
    request(options, function(err, response, body){
        //정상적으로 조회한 경우 호출한 곳으로 프로필 정보를 반환
        if(!error && response.statusCode ==200){
            callback(null, body);
        }else{
            callback(error);
        }
    });
};
```

<br>

람다 함수 배포

```
PS C:\serverless\user-profile> npm run deploy
> user-profile@1.0.0 deploy C:\serverless\user-profile
> aws lambda update-function-code --function-name arn:aws:lambda:us-east-1:256193732381:function:user-profile --zip-file fileb://Lambda-Deployment.zip

{
    "FunctionName": "user-profile",
    "FunctionArn": "arn:aws:lambda:us-east-1:256193732381:function:user-profile",
    "Runtime": "nodejs12.x",
    "Role": "arn:aws:iam::256193732381:role/api-gateway-lambda-exec-role",
    "Handler": "index.handler",
    "CodeSize": 1483642,
    "Description": "",
    "Timeout": 3,
    "MemorySize": 128,
    "LastModified": "2021-03-16T04:38:48.575+0000",
    "CodeSha256": "IBCK3h7e9rsqi10Lu5CiCtuHzjCwzge8663mw/xYH4g=",
    "Version": "$LATEST",
    "TracingConfig": {
        "Mode": "PassThrough"
    },
    "RevisionId": "0fe28e7d-557d-45f5-aa90-bfcf70c94bc6",
    "State": "Active",
    "LastUpdateStatus": "Successful",
    "PackageType": "Zip"
}
```

<br>

lambda 함수가 auth0 도메인과 auth0 비밀번호를 저장하기 위한 두 개의 환경 변수 필요 

- DOMAIN, AUTH0_SECRET 키를 생성한 뒤 auth0.com의 DOMAIN와 Client SECRET을 입력

![image](https://user-images.githubusercontent.com/77096463/111257667-e6133b80-865e-11eb-8f18-895eb2eec529.png)

<br>

**람다함수 테스트**<br>
소셜 로그인 후 브라우저 개발자 도구를 이용해서 localStorage에 저장된 accessToken과 idToken을 추출

![image](https://user-images.githubusercontent.com/77096463/111258118-adc02d00-865f-11eb-9f3a-be28cc841a23.png)

<br>

user-profile 람다 함수의 event로 전달 (<u>authToken의 값은 localStorage에 있는 idToken값을 할당</u>)

```
{
	"accessToken" : "pJzPSP5PMG..", 
	"idToken" : "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpX..."
}
```

<br>

람다 함수 > Configure test event 에서 아래와 같이 accessToken과 authToken 입력

![image](https://user-images.githubusercontent.com/77096463/111258627-afd6bb80-8660-11eb-87ce-66d62b69b0ce.png)

<br>

테스트 실행 결과를 보면 응답에 사용자 프로필 출력되는 것을 확인 

![image](https://user-images.githubusercontent.com/77096463/111258486-700fd400-8660-11eb-90b5-35a2fec878f5.png)

<br>

### API Gateway


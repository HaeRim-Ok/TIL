# Monitoring and Notifications with CloudWatch Events and SNS

**CloudTrail**<br>
AWS 리소스의 모든 읽기, 쓰기 작업의 상세 로그 (작업 내역, 관련 리소스와 리전, 작업 수행자와 작업 시간 등)를 보관<br>
API 작업과 비 API 작업을 모두 기록<br>
 - API 작업 예 : 인스턴스 시작, S3 버킷 생성, VPC 생성 등
 - 비 API 작업 예 : AWS Management Console에 로그인

<br>

**Event** = AWS 계정의 활동 기록
- <u>관리 이벤트</u> = 제어 플레인 작업 (Control Plane Operations)
	- 보안 주체가 AWS 리소스에서 실행하는 작업을 포함
		- 예) 보안 구성 -> IAM AttachRolePolicy API 호출
		- 예) 디바이스 등록 -> EC2 CreateDefaultVPC API 호출
		- 예) 데이터 라우팅 규칙 구성 -> EC2 CreateSubnet API 호출
		- 예) 로깅 설정 -> CloudTrail CreateTrail API 호출
	- 계정에서 발생하는 비 API 이벤트
		- 예) 사용자가 로그인하는 경우 ConsoleLogin 이벤트가 로깅
	- 쓰기 전용, 읽기 전용으로 분류
		- 쓰기 전용 이벤트 : 리소스를 변경하거나 변경할 수 있는 API 작업
		- 읽기 전용 이벤트 : 리소스를 읽기만하고 변경하지 않는 API 작업
- <u>데이터 이벤트</u> = 데이터 플레인 작업
	- 리소스 또는 리소스 내에서 수행되는 리소스 작업에 대한 정보 제공
	- 예) 대량의 작업이 수행되는 S3 객체 수준 활동, Lambda 함수 실행
		- S3 객체 수준 활동 -> GetObject, DeleteObject, PutObject API 호출
		- Lambda 함수 실행 -> Invoke API 호출
	- 추적을 생성할 때 데이터 이벤트는 기본적으로 기록되지 않음 -> 데이터 이벤트를 기록하려면 활동을 수집할 리소스 또는 리소스 유형을 추적에 명시적으로 추가해야 함
- <u>인사이트 이벤트</u> 
  - AWS 계정의 비정상적인 활동을 캡쳐
  - 계정 API 사용량 변화가 계정의 일반적인 사용 패턴과 크게 다를 때 로깅
    - S3 deleteBucket API 호출이 평균적으로 분당 20회 호출 -> 분당 100회 호출 감지한 경우 (비정상적인 활동) -> 비정상적인 활동이 시작될 때와 정상으로 돌아갔을 때를 기록

<br>

**Event History**
- CloudTrail 이벤트에 대한 지난 90일간의 기록
- 조회, 검색, 다운로드 등이 가능
- 리전별로 '이벤트 기록'을 작성, 해당 리전에서의 활동만 기록
- IAM, Route53 등의 글로벌 서비스 이벤트는 모든 리전의 이벤트 기록에 포함

<br>

**Trail**
- 90일이 경과한 이벤트 기록을 저장하거나 CloudTrail이 기록하는 이벤트 유형을 사용자 정의할 때 생성
- 특정 이벤트를 기록하고 지정한 S3버킷에 CloudTrail 로그 파일을 전달, 로그 파일에는 JSON 형식의 로그 항목이 하나 이상 들어 있음
	- eventTime
	- userIdentity
	- eventSource
	- eventName
	- awsRegion
	- sourceIPAddress

<br>

**CloudWatch**
- AWS 리소스와 AWS에서 실시간으로 실행되는 애플리케이션 모니터링
- 리소스와 애플리케이션에 대한 지표(=측정할 수 있는 변수)를 수집하고 추적
- CloudWatch 웹 사이트에는 사용 중인 모든 AWS 서비스에 대한 지표가 자동으로 표시되고, 사용자 지정 대시보드 추가 가능
- 지표를 감시해 알림을 보내거나 임계값을 위반한 경우 모니터링 중인 리소스를 자동으로 변경하는 경보 생성
- 시스템 전체의 리소스 사용량, 애플리케이션 성능 및 운영 상태 파악

<br>

### Lab 구성도

![image](https://user-images.githubusercontent.com/77096463/110055253-00683200-7da0-11eb-8806-8f948f023462.png)

<br>

### Create an SNS Topic and Subscribe an Email Address

SNS 주제 생성 
- 이름 입력
![image](https://user-images.githubusercontent.com/77096463/110052407-e8da7a80-7d9a-11eb-9ad6-4245cc17b379.png)

<br>

구독생성 -> 이후 confirmation 진행
![image](https://user-images.githubusercontent.com/77096463/110052448-f6900000-7d9a-11eb-8fc9-e4d19ee4ab9a.png)

<br>

구독 확인 됨 -> 구독 상태가 '확인됨'
![image](https://user-images.githubusercontent.com/77096463/110052546-13c4ce80-7d9b-11eb-9b17-d406ee21728d.png)

<br>


### Create a CloudWatch Events Rule to Trigger the SNS Topic When There is a State Change to an EC2 Instance

CloudWatch 이벤트 규칙 생성
- 서비스 : EC2
- 이벤트 유형 : EC2 instance State-change Notification
- 대상 : 생성한 SNS 주제 선택
![image](https://user-images.githubusercontent.com/77096463/110052725-643c2c00-7d9b-11eb-900b-0421f866a16d.png)

<br>

이벤트 규칙 이름 부여
![image](https://user-images.githubusercontent.com/77096463/110052794-803fcd80-7d9b-11eb-98c1-bd7137563634.png)

<br>


### Change the State of the EC2 Instance, and Verify the Receipt of the SNS Notification

인스턴스 상태를 중지로 변경한 후 메일이 오는지 확인
![image](https://user-images.githubusercontent.com/77096463/110053059-fe03d900-7d9b-11eb-8c22-b4fd346a33db.png)

<br>

인스턴스 중지 메일
![image](https://user-images.githubusercontent.com/77096463/110053084-0e1bb880-7d9c-11eb-913b-11c0e9502e3e.png)

<br>

인스턴스 재시작 -> 시작 메일
![image](https://user-images.githubusercontent.com/77096463/110053156-32779500-7d9c-11eb-9568-87232917f6fc.png)

<br>

# **AWS EC2 Custom Logging with CloudWatch**

EC2 인스턴스에서 생성되는 로그 정보를 **CloudWatch로 전송해서 로그를 통합** -> EC2 인스턴스에 CloudWatch Logs 에이전트를 설치하고, 로그 서비스를 켜고, 메시지를 수신하도록 CloudWatch를 구성

1. EC2 인스턴스 생성

![image](https://user-images.githubusercontent.com/77096463/110057144-6d30fb80-7da3-11eb-924c-c1ccabb52e94.png)

![image](https://user-images.githubusercontent.com/77096463/110057194-85087f80-7da3-11eb-9c29-4607c97eae09.png)

<br>

2. SSH 접속

![image](https://user-images.githubusercontent.com/77096463/110057363-d31d8300-7da3-11eb-90a7-2354b597f61e.png)

<br>

3. EC2 인스턴스에 awslogs 추가

```
[ec2-user@ip-10-0-0-28 ~]$ sudo yum update -y
Loaded plugins: extras_suggestions, langpacks, priorities, update-motd
No packages marked for update

[ec2-user@ip-10-0-0-28 ~]$ sudo yum install -y awslogs
Loaded plugins: extras_suggestions, langpacks, priorities, update-motd
Resolving Dependencies
--> Running transaction check
---> Package awslogs.noarch 0:1.1.4-3.amzn2 will be installed
--> Processing Dependency: aws-cli-plugin-cloudwatch-logs for package: awslogs-1.1.4-3.amzn2.noarch
--> Running transaction check
---> Package aws-cli-plugin-cloudwatch-logs.noarch 0:1.4.6-1.amzn2.0.1 will be installed
--> Finished Dependency Resolution
```

```
[ec2-user@ip-10-0-0-28 ~]$ cd /etc/awslogs

[ec2-user@ip-10-0-0-28 awslogs]$ ls -l
total 20
-rw------- 1 root root   55 Mar  5 02:14 awscli.conf	//자격증명과 지역정보 포함
-rw-r--r-- 1 root root 8355 Jul 25  2018 awslogs.conf	//cloudwatch 로깅에 대한 설정 정보 포함
drwxr-xr-x 2 root root    6 Jul 25  2018 config
-rw-r--r-- 1 root root  147 Jul 25  2018 proxy.conf
```

4. awslogs 서비스 시작

```
[ec2-user@ip-10-0-0-28 awslogs]$ sudo systemctl start awslogsd
```

awslogs 에이전트가 생성하는 로그 확인
```
[ec2-user@ip-10-0-0-28 awslogs]$ tail -f /var/log/awslogs.log
2021-03-05 02:18:37,216 - cwlogs.push - INFO - 3454 - MainThread - Missing or invalid value for queue_size config. Defaulting to use 10
2021-03-05 02:18:37,216 - cwlogs.push - INFO - 3454 - MainThread - Using default logging configuration.
2021-03-05 02:18:37,233 - cwlogs.push.stream - INFO - 3454 - Thread-1 - Starting publisher for [67811a06abe66c18d08cf0c15c225182, /var/log/messages]
2021-03-05 02:18:37,238 - cwlogs.push.stream - INFO - 3454 - Thread-1 - Starting reader for [67811a06abe66c18d08cf0c15c225182, /var/log/messages]
2021-03-05 02:18:37,239 - cwlogs.push.reader - INFO - 3454 - Thread-4 - Start reading file from 0.
2021-03-05 02:18:43,312 - cwlogs.push.publisher - WARNING - 3454 - Thread-3 - Caught exception: An error occurred (ResourceNotFoundException) when calling the PutLogEvents operation: The specified log group does not exist.
2021-03-05 02:18:43,313 - cwlogs.push.batch - INFO - 3454 - Thread-3 - Creating log group /var/log/messages.
2021-03-05 02:18:43,372 - cwlogs.push.batch - INFO - 3454 - Thread-3 - Creating log stream i-04f1d792e488764ef.
2021-03-05 02:18:43,475 - cwlogs.push.publisher - INFO - 3454 - Thread-3 - Log group: /var/log/messages, log stream: i-04f1d792e488764ef, queue size: 0, Publish batch: {'skipped_events_count': 0, 'first_event': {'timestamp': 1614910326000, 'start_position': 0L, 'end_position': 161L}, 'fallback_events_count': 0, 'last_event': {'timestamp': 1614910716000, 'start_position': 67185L, 'end_position': 67250L}, 'source_id': '67811a06abe66c18d08cf0c15c225182', 'num_of_events': 783, 'batch_size_in_bytes': 86825}
2021-03-05 02:18:48,509 - cwlogs.push.publisher - INFO - 3454 - Thread-3 - Log group: /var/log/messages, log stream: i-04f1d792e488764ef, queue size: 0, Publish batch: {'skipped_events_count': 0, 'first_event': {'timestamp': 1614910722000, 'start_position': 67250L, 'end_position': 67336L}, 'fallback_events_count': 0, 'last_event': {'timestamp': 1614910722000, 'start_position': 67250L, 'end_position': 67336L}, 'source_id': '67811a06abe66c18d08cf0c15c225182', 'num_of_events': 1, 'batch_size_in_bytes': 111}
```

5. 부팅 시 awslogs 서비스 자동 실행

```
[ec2-user@ip-10-0-0-28 awslogs]$ sudo systemctl enable awslogsd.service
Created symlink from /etc/systemd/system/multi-user.target.wants/awslogsd.service to /usr/lib/systemd/system/awslogsd.service.
```

6. EC2에서 보낸 CloudWatch Logs 확인 (수집된 로그 확인) <br>
EC2 인스턴스의 /var/log/messages 파일과 CloudWatch의 /var/log/messages 로그 그룹에 수집된 내용이 일치

![image](https://user-images.githubusercontent.com/77096463/110058510-c863ed80-7da5-11eb-9a3b-a7b8082dc7e7.png)

참고 : https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/QuickStartEC2Instance.html

<br>

# AWS Access Control Alerts with CloudWatch and CloudTrail


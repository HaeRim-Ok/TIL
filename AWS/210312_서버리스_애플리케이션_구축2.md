# 비디오 권한 설정
### 두 번째 람다 함수 생성

lambda 함수 생성

- 이름 : set-permissions
- 런타임 : Node.js 12.x
- 실행 역할 : 기존 역할 사용 -> lambda-s3-execution-role

![image](https://user-images.githubusercontent.com/77096463/110872809-db317180-8313-11eb-83bb-fde98fd69562.png)

<br>

작업 디렉터리 생성 및 모듈 설치

```
PS C:\Users\Lenovo> cd C:\serverless\
PS C:\serverless> mkdir set-permissions


    디렉터리: C:\serverless


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----     2021-03-12   오전 9:20                set-permissions


PS C:\serverless> cd .\set-permissions\
PS C:\serverless\set-permissions> npm init -y
Wrote to C:\serverless\set-permissions\package.json:

{
  "name": "set-permissions",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC"
}

PS C:\serverless\set-permissions> npm install aws-sdk
```

<br>

package.json 수정 (C:\serverless\set-permissions\package.json\)

```json
{
  "name": "set-permissions",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "predeploy" : "zip -r Lambda-Deployment.zip * -x *.zip *.log node_modules/aws-sdk/*",
    "deploy" : "aws lambda update-function-code --function-name [set-permissions_람다함수의_ARN] --zip-file fileb://Lambda-Deployment.zip"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "aws-sdk": "^2.862.0"
  }
}
```

<br>

index.js 생성 후 코드 작성 (C:\serverless\set-permissions\index.js)

```js
//문법을 엄격히 적용
'use strict';  

//node기반의 sdk 가져오기
var AWS = require('aws-sdk');
var s3 = new AWS.S3();

exports.handler = function(event, context, callback){
    //SNS 서비스가 전달한 이벤트 객체에서 동영상이 저장된 버킷과 이름(키) 추출
    var message = JSON.parse(event.Records[0].Sns.Message);	//참조 1
    var sourceBucket = message.Records[0].s3.bucket.name;
    var sourceKey = message.Records[0].s3.object.key;
    sourceKey = decodeURIComponent(sourceKey.replace(/\+/g, ''));

    //동영상의 접근제어목록(ACL) 속성을 public-read로 설정 -> 외부에서 접근 가능
    var params = {
        Bucket: sourceBucket,
        Key: sourceKey,
        ACL: 'public-read'
    }

    s3.putObjectAcl(params, function(err,data){
        if(err){
            callback(err);
        }
    });
}
```

<br>

(참조 1) 람다 함수로 전달되는 이벤트 객체는 다음과 같은 구조 가짐

```
//Records[0].Sns.Message
{
  "Records": [
    {
      "EventSource": "aws:sns",
      "EventVersion": "1.0",
      "EventSubscriptionArn": "arn:aws:sns:us-east-1:{{{accountId}}}:ExampleTopic",
      "Sns": {
        "Type": "Notification",
        "MessageId": "95df01b4-ee98-5cb9-9903-4c221d41eb5e",
        "TopicArn": "arn:aws:sns:us-east-1:123456789012:ExampleTopic",
        "Subject": "example subject",
        "Message": '
		//여기부터 Records[0].s3.bucket.name
        {
	  "Records": [
	    {
	      "eventVersion": "2.0",
	      "eventSource": "aws:s3",
	      "awsRegion": "us-east-1",
	      "eventTime": "1970-01-01T00:00:00.000Z",
	      "eventName": "ObjectCreated:Put",
	      "userIdentity": {
		"principalId": "EXAMPLE"
	      },
	      "requestParameters": {
		"sourceIPAddress": "127.0.0.1"
	      },
	      "responseElements": {
		"x-amz-request-id": "EXAMPLE123456789",
		"x-amz-id-2": "EXAMPLE123/5678abcdefghijklambdaisawesome/mnopqrstuvwxyzABCDEFGH"
	      },
	      "s3": {
		"s3SchemaVersion": "1.0",
		"configurationId": "testConfigRule",
		"bucket": {
		  "name": "example-bucket",
		  "ownerIdentity": {
		    "principalId": "EXAMPLE"
		  },
		  "arn": "arn:aws:s3:::example-bucket"
		},
		"object": {
		  "key": "test/key",
		  "size": 1024,
		  "eTag": "0123456789abcdef0123456789abcdef",
		  "sequencer": "0A1B2C3D4E5F678901"
		}
	      }
	    }
	  ]
	}//
	',
        "Timestamp": "1970-01-01T00:00:00.000Z",
        "SignatureVersion": "1",
        "Signature": "EXAMPLE",
        "SigningCertUrl": "EXAMPLE",
        "UnsubscribeUrl": "EXAMPLE",
        "MessageAttributes": {
          "Test": {
            "Type": "String",
            "Value": "TestString"
          },
          "TestBinary": {
            "Type": "Binary",
            "Value": "TestBinary"
          }
        }
      }
    }
  ]
}

```

(참조 2) S3.putObjectAcl():<br>
https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#putObjectAcl-property

<br>

### 구성 및 보안

람다 작성 코드 배포 후 콘솔에서 반영된 사항 확인

```
PS C:\serverless\set-permissions> npm run deploy
```

![image](https://user-images.githubusercontent.com/77096463/110875120-63b21100-8318-11eb-808a-42fc55f1996a.png)

<br>

SNS 토픽 (transcoded-video-notifications)에 두 번째 람다 함수를 구독에 추가

![image](https://user-images.githubusercontent.com/77096463/110875270-aa077000-8318-11eb-9cb6-19ead065f8ca.png)

<br>

람다 함수가 S3 객체의 ACL을 변경할 수 있는 권한 추가

- lambda-s3-execute-role의 인라인 정책(S3_PutObjectAcl) 추가 -> s3 / PutObjectAcl/트랜스코드 버킷 

![image](https://user-images.githubusercontent.com/77096463/110876010-05862d80-831a-11eb-86ac-698e8ea7ff0a.png)

<br>

![image](https://user-images.githubusercontent.com/77096463/110876195-5dbd2f80-831a-11eb-819e-33dbedf41509.png)

<br>

### 두 번째 람다 함수 테스트

트랜스 코딩된 파일이 저장되는 버킷의 파일 권한 확인 -> '객체 소유자'만이 권한이 있어 외부에서 접근 불가

![image](https://user-images.githubusercontent.com/77096463/110875505-17b39c00-8319-11eb-83b0-68699ea399c1.png)

<br>

업로드 버킷의 파일명 변경

![image](https://user-images.githubusercontent.com/77096463/110876355-a543bb80-831a-11eb-84e7-8135df8d090e.png)

<br>

(1) 테스트 후 첫 번째 람다 함수의 로그 확인

![image](https://user-images.githubusercontent.com/77096463/110876515-f94ea000-831a-11eb-9c7e-7801358496cb.png)

<br>

(2) 트랜스 코딩된 결과가 저장되는 버킷 확인

![image](https://user-images.githubusercontent.com/77096463/110876573-1b482280-831b-11eb-9eef-debfc135e5e8.png)

<br>

(3) 이메일 구독이 실행되었는지 확인

![image](https://user-images.githubusercontent.com/77096463/110876637-3fa3ff00-831b-11eb-9675-86223c00716a.png)

<br>

(4) 두 번째 람다 함수의 로그 파일 확인 -> <u>접근 권한 에러</u>

![image](https://user-images.githubusercontent.com/77096463/110876947-d96bac00-831b-11eb-9b9d-362596fb8e4e.png)

<br>

(5) 파일이 저장된 버킷 (serverless-video-transcoded-haerim) 에 접근 권한이 없어서 파일의 ACL 변경 불가 --> 해당 버킷에 접근할 수 있도록 Public Access 차단 해제 필요 

![image](https://user-images.githubusercontent.com/77096463/110877036-1041c200-831c-11eb-8082-fc787f9fdef7.png)

<br>

(6) (다시 테스트) 업로드 버킷의 파일명 변경<br>
(1)~(4)까지의 과정은 PASS -> (5) 번 과정부터 재확인

![image](https://user-images.githubusercontent.com/77096463/110877186-5d259880-831c-11eb-8a0e-cddb48be3490.png)

<br>

두 번째 람다 함수의 로그 에러

![image](https://user-images.githubusercontent.com/77096463/110882477-58191700-8325-11eb-8fa0-8bdb7df43e9b.png)

<br>

트랜스 코딩된 파일의 ACL 확인 후 객체 URL로 외부에서 호출

![image](https://user-images.githubusercontent.com/77096463/110882585-8991e280-8325-11eb-8d4c-b6a51aacfe28.png)

<br>


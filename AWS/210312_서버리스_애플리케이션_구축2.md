# 비디오 권한 설정
### 두 번째 람다 함수 생성

lambda 함수 생성

- 이름 : set-permissions
- 런타임 : Node.js 12.x
- 실행 역할 : 기존 역할 사용 -> lambda-s3-execution-role

![image](https://user-images.githubusercontent.com/77096463/110872809-db317180-8313-11eb-83bb-fde98fd69562.png)

<br>

작업 디렉터리 생성 및 모듈 설치

```
PS C:\Users\Lenovo> cd C:\serverless\
PS C:\serverless> mkdir set-permissions


    디렉터리: C:\serverless


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----     2021-03-12   오전 9:20                set-permissions


PS C:\serverless> cd .\set-permissions\
PS C:\serverless\set-permissions> npm init -y
Wrote to C:\serverless\set-permissions\package.json:

{
  "name": "set-permissions",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC"
}

PS C:\serverless\set-permissions> npm install aws-sdk
```

<br>

package.json 수정 (C:\serverless\set-permissions\package.json\)

```json
{
  "name": "set-permissions",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "predeploy" : "zip -r Lambda-Deployment.zip * -x *.zip *.log node_modules/aws-sdk/*",
    "deploy" : "aws lambda update-function-code --function-name [set-permissions_람다함수의_ARN] --zip-file fileb://Lambda-Deployment.zip"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "aws-sdk": "^2.862.0"
  }
}
```

<br>

index.js 생성 후 코드 작성 (C:\serverless\set-permissions\index.js)

```js
//문법을 엄격히 적용
'use strict';  

//node기반의 sdk 가져오기
var AWS = require('aws-sdk');
var s3 = new AWS.S3();

exports.handler = function(event, context, callback){
    //SNS 서비스가 전달한 이벤트 객체에서 동영상이 저장된 버킷과 이름(키) 추출
    var message = JSON.parse(event.Records[0].Sns.Message);	//참조 1
    var sourceBucket = message.Records[0].s3.bucket.name;
    var sourceKey = message.Records[0].s3.object.key;
    sourceKey = decodeURIComponent(sourceKey.replace(/\+/g, ''));

    //동영상의 접근제어목록(ACL) 속성을 public-read로 설정 -> 외부에서 접근 가능
    var params = {
        Bucket: sourceBucket,
        Key: sourceKey,
        ACL: 'public-read'
    }

    s3.putObjectAcl(params, function(err,data){
        if(err){
            callback(err);
        }
    });
}
```

<br>

(참조 1) 람다 함수로 전달되는 이벤트 객체는 다음과 같은 구조 가짐

```
//Records[0].Sns.Message
{
  "Records": [
    {
      "EventSource": "aws:sns",
      "EventVersion": "1.0",
      "EventSubscriptionArn": "arn:aws:sns:us-east-1:{{{accountId}}}:ExampleTopic",
      "Sns": {
        "Type": "Notification",
        "MessageId": "95df01b4-ee98-5cb9-9903-4c221d41eb5e",
        "TopicArn": "arn:aws:sns:us-east-1:123456789012:ExampleTopic",
        "Subject": "example subject",
        "Message": '
		//여기부터 Records[0].s3.bucket.name
        {
	  "Records": [
	    {
	      "eventVersion": "2.0",
	      "eventSource": "aws:s3",
	      "awsRegion": "us-east-1",
	      "eventTime": "1970-01-01T00:00:00.000Z",
	      "eventName": "ObjectCreated:Put",
	      "userIdentity": {
		"principalId": "EXAMPLE"
	      },
	      "requestParameters": {
		"sourceIPAddress": "127.0.0.1"
	      },
	      "responseElements": {
		"x-amz-request-id": "EXAMPLE123456789",
		"x-amz-id-2": "EXAMPLE123/5678abcdefghijklambdaisawesome/mnopqrstuvwxyzABCDEFGH"
	      },
	      "s3": {
		"s3SchemaVersion": "1.0",
		"configurationId": "testConfigRule",
		"bucket": {
		  "name": "example-bucket",
		  "ownerIdentity": {
		    "principalId": "EXAMPLE"
		  },
		  "arn": "arn:aws:s3:::example-bucket"
		},
		"object": {
		  "key": "test/key",
		  "size": 1024,
		  "eTag": "0123456789abcdef0123456789abcdef",
		  "sequencer": "0A1B2C3D4E5F678901"
		}
	      }
	    }
	  ]
	}//
	',
        "Timestamp": "1970-01-01T00:00:00.000Z",
        "SignatureVersion": "1",
        "Signature": "EXAMPLE",
        "SigningCertUrl": "EXAMPLE",
        "UnsubscribeUrl": "EXAMPLE",
        "MessageAttributes": {
          "Test": {
            "Type": "String",
            "Value": "TestString"
          },
          "TestBinary": {
            "Type": "Binary",
            "Value": "TestBinary"
          }
        }
      }
    }
  ]
}

```

(참조 2) S3.putObjectAcl():<br>
https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html#putObjectAcl-property

<br>

### 구성 및 보안

람다 작성 코드 배포 후 콘솔에서 반영된 사항 확인

```
PS C:\serverless\set-permissions> npm run deploy
```

![image](https://user-images.githubusercontent.com/77096463/110875120-63b21100-8318-11eb-808a-42fc55f1996a.png)

<br>

SNS 토픽 (transcoded-video-notifications)에 두 번째 람다 함수를 구독에 추가

![image](https://user-images.githubusercontent.com/77096463/110875270-aa077000-8318-11eb-9cb6-19ead065f8ca.png)

<br>

람다 함수가 S3 객체의 ACL을 변경할 수 있는 권한 추가

- lambda-s3-execute-role의 인라인 정책(S3_PutObjectAcl) 추가 -> s3 / PutObjectAcl/트랜스코드 버킷 

![image](https://user-images.githubusercontent.com/77096463/110876010-05862d80-831a-11eb-86ac-698e8ea7ff0a.png)

<br>

![image](https://user-images.githubusercontent.com/77096463/110876195-5dbd2f80-831a-11eb-819e-33dbedf41509.png)

<br>

### 두 번째 람다 함수 테스트

트랜스 코딩된 파일이 저장되는 버킷의 파일 권한 확인 -> '객체 소유자'만이 권한이 있어 외부에서 접근 불가

![image](https://user-images.githubusercontent.com/77096463/110875505-17b39c00-8319-11eb-83b0-68699ea399c1.png)

<br>

업로드 버킷의 파일명 변경

![image](https://user-images.githubusercontent.com/77096463/110876355-a543bb80-831a-11eb-84e7-8135df8d090e.png)

<br>

(1) 테스트 후 첫 번째 람다 함수의 로그 확인

![image](https://user-images.githubusercontent.com/77096463/110876515-f94ea000-831a-11eb-9c7e-7801358496cb.png)

<br>

(2) 트랜스 코딩된 결과가 저장되는 버킷 확인

![image](https://user-images.githubusercontent.com/77096463/110876573-1b482280-831b-11eb-9eef-debfc135e5e8.png)

<br>

(3) 이메일 구독이 실행되었는지 확인

![image](https://user-images.githubusercontent.com/77096463/110876637-3fa3ff00-831b-11eb-9675-86223c00716a.png)

<br>

(4) 두 번째 람다 함수의 로그 파일 확인 -> <u>접근 권한 에러</u>

![image](https://user-images.githubusercontent.com/77096463/110876947-d96bac00-831b-11eb-9b9d-362596fb8e4e.png)

<br>

(5) 파일이 저장된 버킷 (serverless-video-transcoded-haerim) 에 접근 권한이 없어서 파일의 ACL 변경 불가 --> 해당 버킷에 접근할 수 있도록 Public Access 차단 해제 필요 

![image](https://user-images.githubusercontent.com/77096463/110877036-1041c200-831c-11eb-8082-fc787f9fdef7.png)

<br>

(6) (다시 테스트) 업로드 버킷의 파일명 변경<br>
(1)~(4)까지의 과정은 PASS -> (5) 번 과정부터 재확인

![image](https://user-images.githubusercontent.com/77096463/110877186-5d259880-831c-11eb-8a0e-cddb48be3490.png)

<br>

두 번째 람다 함수의 로그 

![image](https://user-images.githubusercontent.com/77096463/110882477-58191700-8325-11eb-8fa0-8bdb7df43e9b.png)

<br>

트랜스 코딩된 파일의 ACL 확인 후 객체 URL로 외부에서 호출

![image](https://user-images.githubusercontent.com/77096463/110882585-8991e280-8325-11eb-8d4c-b6a51aacfe28.png)

<br>

### **set-permissions 람다 함수를 파이썬으로 구현**

lambda 함수 생성

- 이름 : set-permissions-python
- 런타임 : Python 3.7
- 실행 역할 : 기존 역할 사용 -> lambda-s3-execution-role

함수 생성 후 코드 작성 (C:\serverless\set-permissions\index.js 파일을 파이썬으로 변경)

```python
import json
import boto3
from urllib.parse import unquote

s3 = boto3.client('s3')

def lambda_handler(event, context):
    print(event)
    
    message = event['Records'][0]['Sns']['Message']
    print(message)
    
    message = json.loads(message)
    print(message)
    
    source_bucket= message['Records'][0]['s3']['bucket']['name']
    print(source_bucket)
    
    source_key = message['Records'][0]['s3']['object']['key']
    source_key = unquote(source_key.replace("+"," "))
    print(source_key)
    
    response = s3.put_object_acl(Bucket=source_bucket, Key=source_key, ACL='public-read')
    print(response)
    
    print('DONE!')
    
    return response
```

SNS 구독을 추가한 뒤 테스트해보기

-----------------



# 메타데이터 생성

ffprobe 프로그램을 사용해서 동영상 파일의 정보를 기록

- ffprobe 프로그램은 윈도우에서 실행 속성 설정 문제가 있어서, Amazon Linux EC2 인스턴스를 생성해서 해당 인스턴스 내에서 실행할 예정

<br>

### FFprobe 생성

Amazon Linux EC2 인스턴스 생성

- AMI : Amazon Linux 2 AMI
- 키 페어 : exercise-key (기존 키 페어) 선택
- 나머지 사항은 모두 default

![image](https://user-images.githubusercontent.com/77096463/110892921-4ee57580-8338-11eb-8cc6-c1d07af8b566.png)

<br>

인스턴스 SSH 접속 후 node.js 설치

- 참고 : https://docs.aws.amazon.com/ko_kr/sdk-for-javascript/v2/developer-guide/setting-up-node-on-ec2-instance.html

nvm(노드 버전 관리자) 설치

- nvm : 여러 버전의 Node.js를 설치할 수 있고 여러 버전으로 전환할 수 있기 때문에 여기서는 nvm을 사용하여 Node.js를 설치

```
[ec2-user@ip-172-XX-XX-XX ~]$ curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh | bash
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 13226  100 13226    0     0   516k      0 --:--:-- --:--:-- --:--:--  516k
=> Downloading nvm as script to '/home/ec2-user/.nvm'

=> Appending nvm source string to /home/ec2-user/.bashrc
=> Appending bash_completion source string to /home/ec2-user/.bashrc
=> Close and reopen your terminal to start using nvm or run the following to use it now:

export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion
```
nvm 활성화
```
[ec2-user@ip-172-XX-XX-XX ~]$ . ~/.nvm/nvm.sh
```
Node.js의 최신 버전 설치
```
[ec2-user@ip-172-XX-XX-XX ~]$ nvm install node
Downloading and installing node v15.11.0...
Downloading https://nodejs.org/dist/v15.11.0/node-v15.11.0-linux-x64.tar.xz...
############################################################################################# 100.0%
Computing checksum with sha256sum
Checksums matched!
npm notice
npm notice New patch version of npm available! 7.6.0 -> 7.6.3
npm notice Changelog: https://github.com/npm/cli/releases/tag/v7.6.3
npm notice Run npm install -g npm@7.6.3 to update!
npm notice
Now using node v15.11.0 (npm v7.6.0)
Creating default alias: default -> node (-> v15.11.0)
```
Node.js가 올바르게 설치되고 실행되는지 테스트
```
[ec2-user@ip-172-XX-XX-XX ~]$ node -e "console.log('Running Node.js ' + process.version)"
Running Node.js v15.11.0
```

12버전으로 바꿔주기

```
[ec2-user@ip-172-XX-XX-XX ~]$ nvm install v12.19.0
Downloading and installing node v12.19.0...
Downloading https://nodejs.org/dist/v12.19.0/node-v12.19.0-linux-x64.tar.xz...
############################################################################################# 100.0%
Computing checksum with sha256sum
Checksums matched!
Now using node v12.19.0 (npm v6.14.8)
```

<br>

인스턴스의 리눅스 버전에 해당하는 ffmpeg 정적 빌드 다운로드

> ffmpeg : 비디오 및 오디오를 기록하고 변환하는 명령행 유틸리티

리눅스 인스턴스에서 https://www.johnvansickle.com/ffmpeg/old-releases/ 사이트의  'ffmpeg-4.2.2-amd64-static.tar.xz' 다운받기

```
[ec2-user@ip-172-XX-XX-XX ~]$ wget https://www.johnvansickle.com/ffmpeg/old-releases/ffmpeg-4.2.2-amd64-static.tar.xz
```

다운받은 파일 설치

```
[ec2-user@ip-172-XX-XX-XX ~]$ xz -d ffmpeg-4.2.2-amd64-static.tar.xz
[ec2-user@ip-172-XX-XX-XX ~]$ tar xvf ffmpeg-4.2.2-amd64-static.tar

[ec2-user@ip-172-XX-XX-XX ffmpeg-4.2.2-amd64-static]$ ll
total 145312
-rwxr-xr-x 1 ec2-user ec2-user 74074472 Mar  2  2020 ffmpeg
-rwxr-xr-x 1 ec2-user ec2-user 73988648 Mar  2  2020 ffprobe	//미디어 정보 추출
-rw-r--r-- 1 ec2-user ec2-user    35147 Mar  2  2020 GPLv3.txt
drwxr-xr-x 2 ec2-user ec2-user      309 Mar  2  2020 manpages
drwxr-xr-x 7 ec2-user ec2-user      255 Mar  2  2020 model
-rwxr-xr-x 1 ec2-user ec2-user   690888 Mar  2  2020 qt-faststart
-rw-r--r-- 1 ec2-user ec2-user     2140 Mar  2  2020 readme.txt
```

<br>

### 세 번째 람다 함수 생성

(트랜스 코딩된 3개의) 동영상 파일의 메타 정보 추출하여 S3 버킷(트랜스 코딩된 파일이 저장되는 버킷)에 저장하는 용도

![image](https://user-images.githubusercontent.com/77096463/110894284-f06dc680-833a-11eb-80c9-b05557da1fe8.png)

<br>

동영상 작업을 해야하므로 기본 설정을 메모리는 256MB로, 제한 시간은 2분으로 변경 

![image](https://user-images.githubusercontent.com/77096463/110894428-388ce900-833b-11eb-8491-cb9c1bbfe4e6.png)

<br>

세 번째 람다 함수 소스 코드 작성 (EC2 인스턴스에서 작업 -> 람다 함수에 ffprobe를 포함해서 배포해야 하므로)

```
//작업 디렉터리 생성 및 이동
[ec2-user@ip-172-XX-XX-XX ffmpeg-4.2.2-amd64-static]$ cd
[ec2-user@ip-172-XX-XX-XX ~]$ mkdir extract-metadata
[ec2-user@ip-172-XX-XX-XX ~]$ cd extract-metadata/
[ec2-user@ip-172-XX-XX-XX extract-metadata]$ mkdir bin
[ec2-user@ip-172-XX-XX-XX extract-metadata]$ mkdir tmp
[ec2-user@ip-172-XX-XX-XX extract-metadata]$ npm init -y
Wrote to /home/ec2-user/extract-metadata/package.json:

{
  "name": "extract-metadata",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC"
}
```

```
[ec2-user@ip-172-XX-XX-XX extract-metadata]$ npm install aws-sdk
```

<br>

package.json에 predeploy, deploy script 추가

```
[ec2-user@ip-172-XX-XX-XX extract-metadata]$ vi package.json
```
```json
//package.json
{
  "name": "extract-metadata",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
        "predeploy" : "zip -r Lambda-Deployment.zip * -x *.zip *.log node_modules/aws-sdk/*",
        "deploy" : "aws lambda update-function-code --function-name [extract-metadata_함수의_ARN] --zip-file fileb://Lambda-Deployment.zip"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "aws-sdk": "^2.862.0"
  }
}
```

index.js 파일을 생성 및 작성

```
[ec2-user@ip-172-XX-XX-XX extract-metadata]$ vi index.js
```

```js
//index.js
'use strict';
var AWS = require('aws-sdk');
var exec = require('child_process').exec;
var fs = require('fs');

process.env['PATH'] = process.env['PATH'] + ':' + process.env['LAMBDA_TASK_ROOT'];

var s3 = new AWS.S3();

function saveMetadataToS3(body, bucket, key, callback) {
    console.log('Saving metadata to S3');
    s3.putObject({
        Bucket: bucket, 
        Key: key, 
        Body: body
    }, function(error, data) {
        if (error) {
            callback(error);
        }
    });
}

function extractMetadata(sourceBucket, sourceKey, localFilename, callback) {
    console.log('Extracting metadata');

    var cmd = 'bin/ffprobe -v quiet -print_format json -show_format "/tmp/' + localFilename + '"';
    exec(cmd, function(error, stdout, stderr) {
        if (error === null) {
            var metadataKey = sourceKey.split('.')[0] + '.json';
            saveMetadataToS3(stdout, sourceBucket, metadataKey, callback);
        } else {
            console.log(stderr);
            callback(error);
        }
    });
}

function saveFileToFilesystem(sourceBucket, sourceKey, callback) {
    console.log('Saving to filesystem');

    var localFilename = sourceKey.split('/').pop();
    var file = fs.createWriteStream('/tmp/' + localFilename);

    var stream = s3.getObject({
        Bucket: sourceBucket, 
        Key: sourceKey
    }).createReadStream().pipe(file);

    stream.on('error', function(error) {
        callback(error);
    });

    stream.on('close', function() {
        extractMetadata(sourceBucket, sourceKey, localFilename, callback);
    });
}

exports.handler = function (event, context, callback) {
    var message = JSON.parse(event.Records[0].Sns.Message);
    var sourceBucket = message.Records[0].s3.bucket.name;
    var sourceKey = decodeURIComponent(message.Records[0].s3.object.key.replace(/\+/g, ' '));

    saveFileToFilesystem(sourceBucket, sourceKey, callback);
};
```





